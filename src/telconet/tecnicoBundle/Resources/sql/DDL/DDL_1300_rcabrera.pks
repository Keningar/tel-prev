/**
 * Vista que obtiene informaci√≥n del Telcos sobre las IPs reportadas por Ecucert
 *
 * @author Richard Cabrera <rcabrera@telconet.ec>
 * @version 1.0 10/01/2019
 */

CREATE OR REPLACE FORCE VIEW DB_COMERCIAL.V_SEGURIDAD_ECUCERT
AS SELECT 

INFOPUNTO.LOGIN AS LOGIN,

INFOSERVICIO.LOGIN_AUX,

( case when (infoPersona.nombres is null) then infoPersona.razon_social else infoPersona.nombres||' '||infoPersona.apellidos end) as nombre_cliente,

ADMIJURISDICCION.NOMBRE_JURISDICCION AS PUNTO_COBERTURA,

INFOIP.IP AS IP,

INFOIP.TIPO_IP AS TIPO_IP,

(SELECT LISTAGG(RED_LAN, '|') WITHIN GROUP (ORDER BY RED_LAN DESC) AS REDES_ASIGNADAS
FROM DB_INFRAESTRUCTURA.INFO_RUTA_ELEMENTO WHERE SERVICIO_ID = INFOSERVICIO.ID_SERVICIO AND ESTADO = 'Activo') AS REDES_ASIGNADAS,

(SELECT LISTAGG(REGEXP_SUBSTR(FC.VALOR,'[a-zA-Z0-9._%-]+@[a-zA-Z0-9._%-]+\.[a-zA-Z]{2,4}'), '|') WITHIN GROUP (ORDER BY FC.VALOR DESC) AS CONTACTO_TECNICO
                      FROM 
                        DB_COMERCIAL.INFO_PUNTO_CONTACTO PC,
                        DB_COMERCIAL.INFO_PERSONA_FORMA_CONTACTO FC,
                        DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL PER,
                        DB_COMERCIAL.INFO_EMPRESA_ROL ER,
                        DB_COMERCIAL.ADMI_ROL R  
                      WHERE PC.PUNTO_ID        = INFOSERVICIO.PUNTO_ID
                      AND PER.ID_PERSONA_ROL   = PC.PERSONA_EMPRESA_ROL_ID
                      AND PER.EMPRESA_ROL_ID   = ER.ID_EMPRESA_ROL
                      AND ER.ROL_ID            = R.ID_ROL
                      AND PC.CONTACTO_ID       = FC.PERSONA_ID
                      AND FC.FORMA_CONTACTO_ID = 5
                      AND FC.ESTADO            = 'Activo'
                      AND PC.ESTADO            = 'Activo'
                      AND R.DESCRIPCION_ROL    = 'Contacto Tecnico') AS CONTACTO_TECNICO,
                      
INFOSERVICIO.ESTADO AS ESTADO_CLIENTE,      

(SELECT  CASE WHEN (count(P.NOMBRES) = 0) THEN 'NO' ELSE 'SI' END
                       FROM       DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL_CARAC PERC 
                       INNER JOIN DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL       PER  ON PER.ID_PERSONA_ROL  = COALESCE(TO_NUMBER(REGEXP_SUBSTR(PERC.VALOR,'^\d+')),0)
                       INNER JOIN DB_COMERCIAL.INFO_EMPRESA_ROL               ER   ON ER.ID_EMPRESA_ROL   = PER.EMPRESA_ROL_ID
                       INNER JOIN DB_COMERCIAL.INFO_PERSONA                   P    ON P.ID_PERSONA        = PER.PERSONA_ID
                       INNER JOIN DB_COMERCIAL.ADMI_CARACTERISTICA            C    ON C.ID_CARACTERISTICA = PERC.CARACTERISTICA_ID
                       WHERE PERC.PERSONA_EMPRESA_ROL_ID  = INFOPUNTO.PERSONA_EMPRESA_ROL_ID
                       AND   C.DESCRIPCION_CARACTERISTICA = 'ID_VIP'
                       AND   PERC.ESTADO                  = 'Activo'
                       AND   ER.EMPRESA_COD               = '10') AS TIENE_ASIGNADO_VIP,

(SELECT LISTAGG(UPPER(P.NOMBRES || ' ' || P.APELLIDOS), '|') WITHIN GROUP (ORDER BY NOMBRES DESC) AS INGENIERO_VIP
                       FROM       DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL_CARAC PERC 
                       INNER JOIN DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL       PER  ON PER.ID_PERSONA_ROL  = COALESCE(TO_NUMBER(REGEXP_SUBSTR(PERC.VALOR,'^\d+')),0)
                       INNER JOIN DB_COMERCIAL.INFO_EMPRESA_ROL               ER   ON ER.ID_EMPRESA_ROL   = PER.EMPRESA_ROL_ID
                       INNER JOIN DB_COMERCIAL.INFO_PERSONA                   P    ON P.ID_PERSONA        = PER.PERSONA_ID
                       INNER JOIN DB_COMERCIAL.ADMI_CARACTERISTICA            C    ON C.ID_CARACTERISTICA = PERC.CARACTERISTICA_ID
                       WHERE PERC.PERSONA_EMPRESA_ROL_ID  = INFOPUNTO.PERSONA_EMPRESA_ROL_ID
                       AND   C.DESCRIPCION_CARACTERISTICA = 'ID_VIP'
                       AND   PERC.ESTADO                  = 'Activo'
                       AND   ER.EMPRESA_COD               = '10') AS INGENIERO_VIP,

(select CASE WHEN (count(vScanning.id_servicio) = 0) THEN 'NO' ELSE 'SI' END
FROM DB_COMERCIAL.V_SCANNING_FIREWALL VSCANNING WHERE VSCANNING.LOGIN = INFOPUNTO.LOGIN AND VSCANNING.ESTADO_SERVICIO = 'Activo') AS SERVICIOS_GESTIONADOS,

(SELECT NOMBRE_EMPRESA FROM DB_COMERCIAL.INFO_EMPRESA_GRUPO WHERE COD_EMPRESA = (SELECT EMPRESA_ID FROM DB_COMERCIAL.INFO_OFICINA_GRUPO WHERE ID_OFICINA = 
(SELECT OFICINA_ID FROM DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL 
WHERE ID_PERSONA_ROL = (SELECT PERSONA_EMPRESA_ROL_ID FROM DB_COMERCIAL.INFO_PUNTO WHERE ID_PUNTO = INFOSERVICIO.PUNTO_ID)))) AS EMPRESA


FROM DB_COMERCIAL.INFO_IP INFOIP,
DB_COMERCIAL.INFO_SERVICIO INFOSERVICIO,
DB_COMERCIAL.INFO_PUNTO INFOPUNTO,
DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL INFOPERSONAEMPRESAROL,
DB_COMERCIAL.INFO_PERSONA INFOPERSONA,
DB_COMERCIAL.ADMI_JURISDICCION ADMIJURISDICCION

WHERE INFOIP.SERVICIO_ID = INFOSERVICIO.ID_SERVICIO
AND INFOSERVICIO.PUNTO_ID = INFOPUNTO.ID_PUNTO
AND INFOPUNTO.PERSONA_EMPRESA_ROL_ID = INFOPERSONAEMPRESAROL.ID_PERSONA_ROL
AND INFOPERSONAEMPRESAROL.PERSONA_ID = INFOPERSONA.ID_PERSONA
AND INFOPUNTO.PUNTO_COBERTURA_ID = ADMIJURISDICCION.ID_JURISDICCION 
AND INFOIP.ESTADO = 'Activo'
AND INFOPUNTO.PERSONA_EMPRESA_ROL_ID IN (
                        (SELECT ID_PERSONA_ROL FROM DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL WHERE OFICINA_ID IN (
                        SELECT ID_OFICINA FROM DB_COMERCIAL.INFO_OFICINA_GRUPO WHERE EMPRESA_ID IN (10,18))));

/
