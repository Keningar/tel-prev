/**
 * Vista que presenta la información del cliente con su respectivo servicio y las ips relacionadas a los Cpes
 * 
 * @author Mildred Cruz <mlcruz@telconet.ec>
 * @version 1.0 12/10/2018
 */
CREATE OR REPLACE FORCE VIEW "DB_COMERCIAL"."V_SCANNING_CPE" (  "NOMBRE_OFICINA", 
                                                                "CLIENTE", 
                                                                "LOGIN", 
                                                                "REGION", 
                                                                "OFICINA_COBERTURA", 
                                                                "IP_INTERFACE", 
                                                                "NOMBRE_CPE", 
                                                                "MECANISMO", 
                                                                "DESCRIPCION_ADMINISTRACION", 
                                                                "FECHA_ACTIVACION", 
                                                                "ID_SERVICIO", 
                                                                "ESTADO_SERVICIO", 
                                                                "ULTIMA_MILLA_ID", 
                                                                "CPE_DIRECTO", 
                                                                "DESCRIPCION_ROL", 
                                                                "TIPO_IDENTIFICACION", 
                                                                "IDENTIFICACION_CLIENTE", 
                                                                "CONTACTO_CLIENTE", 
                                                                "VALOR_CONTACTO_CLIENTE", 
                                                                "TIPO_CONTACTO", 
                                                                "FORMA_CONTACTO")
AS
SELECT OFICINA.NOMBRE_OFICINA,
  NVL( PERSONA.RAZON_SOCIAL, CONCAT( PERSONA.NOMBRES, CONCAT(' ', PERSONA.APELLIDOS) ) ) AS CLIENTE,
  PUNTO.LOGIN,
  CANTON.REGION,
  JURISDICCION.NOMBRE_JURISDICCION AS OFICINA_COBERTURA,
  INFO_TECNICA_SERVICIO.IP         AS IP_INTERFACE,
  ELEMENTO.NOMBRE_ELEMENTO         AS NOMBRE_CPE,
  PRODUCTO.DESCRIPCION_PRODUCTO    AS MECANISMO,
  DETALLE_ELEMENTO.DETALLE_VALOR AS DESCRIPCION_ADMINISTRACION,
  INFO_TECNICA_SERVICIO.FE_CREACION AS FECHA_ACTIVACION,
  SERVICIO.ID_SERVICIO,
  SERVICIO.ESTADO AS ESTADO_SERVICIO,
  INFO_TECNICA_SERVICIO.ULTIMA_MILLA_ID,
  INFO_TECNICA_SERVICIO.CPE_DIRECTO,
  ROL_CLIENTE.DESCRIPCION_ROL,
  PERSONA.TIPO_IDENTIFICACION,
  PERSONA.IDENTIFICACION_CLIENTE,
  INFO_CONTACTO.CONTACTO_CLIENTE,
  INFO_CONTACTO.VALOR_CONTACTO_CLIENTE,
  INFO_CONTACTO.TIPO_CONTACTO,
  INFO_CONTACTO.FORMA_CONTACTO
FROM DB_COMERCIAL.INFO_SERVICIO SERVICIO
INNER JOIN DB_COMERCIAL.INFO_PUNTO PUNTO
ON PUNTO.ID_PUNTO = SERVICIO.PUNTO_ID
INNER JOIN DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL PER
ON PER.ID_PERSONA_ROL = PUNTO.PERSONA_EMPRESA_ROL_ID
INNER JOIN DB_COMERCIAL.INFO_EMPRESA_ROL IER_CLIENTE
ON IER_CLIENTE.ID_EMPRESA_ROL = PER.EMPRESA_ROL_ID
INNER JOIN DB_GENERAL.ADMI_ROL ROL_CLIENTE
ON ROL_CLIENTE.ID_ROL = IER_CLIENTE.ROL_ID
INNER JOIN DB_COMERCIAL.INFO_OFICINA_GRUPO OFICINA
ON OFICINA.ID_OFICINA = PER.OFICINA_ID
INNER JOIN DB_INFRAESTRUCTURA.ADMI_JURISDICCION JURISDICCION
ON JURISDICCION.ID_JURISDICCION = PUNTO.PUNTO_COBERTURA_ID
INNER JOIN DB_GENERAL.ADMI_CANTON CANTON
ON CANTON.ID_CANTON = OFICINA.CANTON_ID
INNER JOIN DB_COMERCIAL.ADMI_PRODUCTO PRODUCTO
ON PRODUCTO.ID_PRODUCTO = SERVICIO.PRODUCTO_ID
INNER JOIN DB_COMERCIAL.INFO_PERSONA PERSONA
ON PERSONA.ID_PERSONA = PER.PERSONA_ID
INNER JOIN
  (SELECT INFO_SERVICIO_IP_ENLACE.SERVICIO_ID,
    INFO_SERVICIO_IP_ENLACE.ID_IP,
    INFO_SERVICIO_IP_ENLACE.IP,
    INFO_SERVICIO_IP_ENLACE.INTERFACE_ELEMENTO_CLIENTE_ID,
    INFO_SERVICIO_IP_ENLACE.ULTIMA_MILLA_ID,
    INFO_SERVICIO_IP_ENLACE.ELEMENTO_CLIENTE_ID,
    INFO_SERVICIO_IP_ENLACE.FE_CREACION,
    (
    CASE
      WHEN (INFO_SERVICIO_IP_ENLACE.CANTIDAD_ENLACES = 0)
      THEN INFO_SERVICIO_IP_ENLACE.ELEMENTO_CLIENTE_ID
      ELSE DB_COMERCIAL.COMEK_CONSULTAS.F_GET_ID_ELEMENTO_PRINCIPAL(INFO_SERVICIO_IP_ENLACE.INTERFACE_ELEMENTO_CLIENTE_ID,'CPE')
    END) AS ID_CPE,
    (
    CASE
      WHEN (INFO_SERVICIO_IP_ENLACE.CANTIDAD_ENLACES = 0)
      THEN 'SI'
      ELSE 'NO'
    END) AS CPE_DIRECTO
  FROM
    (SELECT SERVICIO_TECNICO.SERVICIO_ID,
      IP.ID_IP,
      IP.IP,
      SERVICIO_TECNICO.INTERFACE_ELEMENTO_CLIENTE_ID,
      SERVICIO_TECNICO.ULTIMA_MILLA_ID,
      SERVICIO_TECNICO.ELEMENTO_CLIENTE_ID,
      IP.FE_CREACION,
      COUNT(ENLACE.ID_ENLACE) AS CANTIDAD_ENLACES
    FROM DB_COMERCIAL.INFO_SERVICIO_TECNICO SERVICIO_TECNICO
    INNER JOIN DB_INFRAESTRUCTURA.ADMI_TIPO_MEDIO UM
    ON UM.ID_TIPO_MEDIO = SERVICIO_TECNICO.ULTIMA_MILLA_ID
    INNER JOIN DB_INFRAESTRUCTURA.INFO_IP IP
    ON IP.SERVICIO_ID = SERVICIO_TECNICO.SERVICIO_ID
    LEFT JOIN DB_INFRAESTRUCTURA.INFO_ENLACE ENLACE
    ON ENLACE.INTERFACE_ELEMENTO_INI_ID = SERVICIO_TECNICO.INTERFACE_ELEMENTO_CLIENTE_ID
    WHERE UM.CODIGO_TIPO_MEDIO         IN ('FO','RAD','UTP')
    AND IP.ESTADO = 'Activo'
    GROUP BY (SERVICIO_TECNICO.SERVICIO_ID, IP.ID_IP, IP.IP, SERVICIO_TECNICO.INTERFACE_ELEMENTO_CLIENTE_ID, 
              SERVICIO_TECNICO.ULTIMA_MILLA_ID, SERVICIO_TECNICO.ELEMENTO_CLIENTE_ID, IP.FE_CREACION)
    ) INFO_SERVICIO_IP_ENLACE
  ) INFO_TECNICA_SERVICIO ON INFO_TECNICA_SERVICIO.SERVICIO_ID = SERVICIO.ID_SERVICIO
INNER JOIN DB_INFRAESTRUCTURA.INFO_ELEMENTO ELEMENTO
ON ELEMENTO.ID_ELEMENTO = INFO_TECNICA_SERVICIO.ID_CPE
INNER JOIN DB_INFRAESTRUCTURA.INFO_DETALLE_ELEMENTO DETALLE_ELEMENTO
ON DETALLE_ELEMENTO.ELEMENTO_ID = ELEMENTO.ID_ELEMENTO 
LEFT JOIN
  (SELECT PUNTO_CONTACTO.PUNTO_ID,
    PUNTO_CONTACTO.ID_PUNTO_CONTACTO,
    NVL( PERSONA_CONTACTO.RAZON_SOCIAL, CONCAT( PERSONA_CONTACTO.NOMBRES, CONCAT(' ', PERSONA_CONTACTO.APELLIDOS) ) ) AS CONTACTO_CLIENTE,
    PERSONA_F_CONTACTO.VALOR                                                                                          AS VALOR_CONTACTO_CLIENTE,
    ROL_CONTACTO.DESCRIPCION_ROL                                                                                      AS TIPO_CONTACTO,
    FORMA_CONTACTO.DESCRIPCION_FORMA_CONTACTO                                                                         AS FORMA_CONTACTO
  FROM DB_COMERCIAL.INFO_PUNTO_CONTACTO PUNTO_CONTACTO
  INNER JOIN DB_COMERCIAL.INFO_PERSONA_FORMA_CONTACTO PERSONA_F_CONTACTO
  ON PERSONA_F_CONTACTO.PERSONA_ID = PUNTO_CONTACTO.CONTACTO_ID
  INNER JOIN DB_COMERCIAL.INFO_PERSONA PERSONA_CONTACTO
  ON PERSONA_CONTACTO.ID_PERSONA = PERSONA_F_CONTACTO.PERSONA_ID
  INNER JOIN DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL PER_CONTACTO
  ON PER_CONTACTO.ID_PERSONA_ROL = PUNTO_CONTACTO.PERSONA_EMPRESA_ROL_ID
  INNER JOIN DB_COMERCIAL.INFO_EMPRESA_ROL IER
  ON IER.ID_EMPRESA_ROL = PER_CONTACTO.EMPRESA_ROL_ID
  INNER JOIN DB_GENERAL.ADMI_ROL ROL_CONTACTO
  ON ROL_CONTACTO.ID_ROL = IER.ROL_ID
  INNER JOIN DB_GENERAL.ADMI_TIPO_ROL TIPO_ROL_CONTACTO
  ON TIPO_ROL_CONTACTO.ID_TIPO_ROL = ROL_CONTACTO.TIPO_ROL_ID
  INNER JOIN DB_COMERCIAL.ADMI_FORMA_CONTACTO FORMA_CONTACTO
  ON FORMA_CONTACTO.ID_FORMA_CONTACTO            = PERSONA_F_CONTACTO.FORMA_CONTACTO_ID
  WHERE PUNTO_CONTACTO.ESTADO                    = 'Activo'
  AND PERSONA_F_CONTACTO.ESTADO                  = 'Activo'
  AND ROL_CONTACTO.DESCRIPCION_ROL               = 'Contacto Tecnico'
  AND TIPO_ROL_CONTACTO.DESCRIPCION_TIPO_ROL     = 'Contacto'
  AND FORMA_CONTACTO.DESCRIPCION_FORMA_CONTACTO IN ('Correo Electronico', 'Telefono Fijo', 'Telefono Movil', 'Telefono Movil Claro', 
                                                    'Telefono Movil Movistar', 'Telefono Movil CNT')
  AND FORMA_CONTACTO.ESTADO                      = 'Activo'
  ) INFO_CONTACTO ON INFO_CONTACTO.PUNTO_ID      = PUNTO.ID_PUNTO
WHERE SERVICIO.ESTADO                           IN ('Activo','In-Corte','EnPruebas')
AND PRODUCTO.EMPRESA_COD                         = '10'
AND DETALLE_ELEMENTO.ESTADO = 'Activo'
AND DETALLE_NOMBRE = 'ADMINISTRA';

/**
 * Vista que presenta la información de clientes con servicios de seguridad gestionada
 * 
 * @author Mildred Cruz <mlcruz@telconet.ec>
 * @version 1.0 12/10/2018
 */
CREATE OR REPLACE FORCE VIEW "DB_COMERCIAL"."V_SCANNING_FIREWALL" ( "ID_SERVICIO", 
                                                                    "NOMBRE_OFICINA", 
                                                                    "CLIENTE", 
                                                                    "TIPO_IDENTIFICACION", 
                                                                    "IDENTIFICACION_CLIENTE", 
                                                                    "COBERTURA", 
                                                                    "NOMBRE_SECTOR", 
                                                                    "NOMBRE_CANTON", 
                                                                    "NOMBRE_PROVINCIA", 
                                                                    "NOMBRE_PARROQUIA", 
                                                                    "LOGIN", 
                                                                    "ESTADO_SERVICIO", 
                                                                    "DESCRIPCION_FACTURA",
                                                                    "FECHA_ACTIVACION", 
                                                                    "DESCRIPCION_PRODUCTO", 
                                                                    "CONTACTO_CLIENTE", 
                                                                    "VALOR_CONTACTO_CLIENTE", 
                                                                    "TIPO_CONTACTO", 
                                                                    "FORMA_CONTACTO", 
                                                                    "OBSERVACION" )
AS
SELECT SERVICIO.ID_SERVICIO,
  OFICINA.NOMBRE_OFICINA,
  NVL( PERSONA.RAZON_SOCIAL, CONCAT( PERSONA.NOMBRES, CONCAT(' ', PERSONA.APELLIDOS) ) ) AS CLIENTE,
  PERSONA.TIPO_IDENTIFICACION,
  PERSONA.IDENTIFICACION_CLIENTE,
  JURISDICCION.NOMBRE_JURISDICCION AS COBERTURA,
  SECTOR.NOMBRE_SECTOR,
  CANTON.NOMBRE_CANTON,
  PROVINCIA.NOMBRE_PROVINCIA,
  PARROQUIA.NOMBRE_PARROQUIA,
  PUNTO.LOGIN,
  SERVICIO.ESTADO AS ESTADO_SERVICIO,
  SERVICIO.DESCRIPCION_PRESENTA_FACTURA AS DESCRIPCION_FACTURA,
  (SELECT FE_CREACION
  FROM DB_COMERCIAL.INFO_SERVICIO_HISTORIAL
  WHERE ID_SERVICIO_HISTORIAL =
    (SELECT MIN(ID_SERVICIO_HISTORIAL)
    FROM DB_COMERCIAL.INFO_SERVICIO_HISTORIAL
    WHERE ESTADO    ='Activo'
    AND SERVICIO_ID = SERVICIO.ID_SERVICIO
    )
  ) AS FECHA_ACTIVACION,
  PRODUCTO.DESCRIPCION_PRODUCTO,
  INFO_CONTACTO.CONTACTO_CLIENTE,
  INFO_CONTACTO.VALOR_CONTACTO_CLIENTE,
  INFO_CONTACTO.TIPO_CONTACTO,
  INFO_CONTACTO.FORMA_CONTACTO,
  (SELECT OBSERVACION
  FROM DB_COMERCIAL.INFO_SERVICIO_HISTORIAL
  WHERE ID_SERVICIO_HISTORIAL =
    (SELECT MIN(ID_SERVICIO_HISTORIAL)
    FROM DB_COMERCIAL.INFO_SERVICIO_HISTORIAL
    WHERE ESTADO    ='Activo'
    AND ACCION      ='confirmarServicio'
    AND SERVICIO_ID = SERVICIO.ID_SERVICIO
    )
  ) AS OBSERVACION
FROM DB_COMERCIAL.INFO_SERVICIO SERVICIO
INNER JOIN DB_COMERCIAL.INFO_PUNTO PUNTO
ON PUNTO.ID_PUNTO = SERVICIO.PUNTO_ID
INNER JOIN DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL PER
ON PER.ID_PERSONA_ROL = PUNTO.PERSONA_EMPRESA_ROL_ID
INNER JOIN DB_COMERCIAL.INFO_OFICINA_GRUPO OFICINA
ON OFICINA.ID_OFICINA = PER.OFICINA_ID
INNER JOIN DB_INFRAESTRUCTURA.ADMI_JURISDICCION JURISDICCION
ON JURISDICCION.ID_JURISDICCION = PUNTO.PUNTO_COBERTURA_ID
INNER JOIN DB_GENERAL.ADMI_SECTOR SECTOR
ON SECTOR.ID_SECTOR = PUNTO.SECTOR_ID
INNER JOIN DB_GENERAL.ADMI_PARROQUIA PARROQUIA
ON PARROQUIA.ID_PARROQUIA = SECTOR.PARROQUIA_ID
INNER JOIN DB_GENERAL.ADMI_CANTON CANTON
ON CANTON.ID_CANTON = PARROQUIA.CANTON_ID
INNER JOIN DB_GENERAL.ADMI_PROVINCIA PROVINCIA
ON PROVINCIA.ID_PROVINCIA = CANTON.PROVINCIA_ID
INNER JOIN DB_COMERCIAL.ADMI_PRODUCTO PRODUCTO
ON PRODUCTO.ID_PRODUCTO = SERVICIO.PRODUCTO_ID
INNER JOIN DB_COMERCIAL.INFO_PERSONA PERSONA
ON PERSONA.ID_PERSONA = PER.PERSONA_ID
LEFT JOIN
  (SELECT PUNTO_CONTACTO.PUNTO_ID,
    PUNTO_CONTACTO.ID_PUNTO_CONTACTO,
    NVL( PERSONA_CONTACTO.RAZON_SOCIAL, CONCAT( PERSONA_CONTACTO.NOMBRES, CONCAT(' ', PERSONA_CONTACTO.APELLIDOS) ) ) AS CONTACTO_CLIENTE,
    PERSONA_F_CONTACTO.VALOR                                                                                          AS VALOR_CONTACTO_CLIENTE,
    ROL_CONTACTO.DESCRIPCION_ROL                                                                                      AS TIPO_CONTACTO,
    FORMA_CONTACTO.DESCRIPCION_FORMA_CONTACTO                                                                         AS FORMA_CONTACTO
  FROM DB_COMERCIAL.INFO_PUNTO_CONTACTO PUNTO_CONTACTO
  INNER JOIN DB_COMERCIAL.INFO_PERSONA_FORMA_CONTACTO PERSONA_F_CONTACTO
  ON PERSONA_F_CONTACTO.PERSONA_ID = PUNTO_CONTACTO.CONTACTO_ID
  INNER JOIN DB_COMERCIAL.INFO_PERSONA PERSONA_CONTACTO
  ON PERSONA_CONTACTO.ID_PERSONA = PERSONA_F_CONTACTO.PERSONA_ID
  INNER JOIN DB_COMERCIAL.INFO_PERSONA_EMPRESA_ROL PER_CONTACTO
  ON PER_CONTACTO.ID_PERSONA_ROL = PUNTO_CONTACTO.PERSONA_EMPRESA_ROL_ID
  INNER JOIN DB_COMERCIAL.INFO_EMPRESA_ROL IER
  ON IER.ID_EMPRESA_ROL = PER_CONTACTO.EMPRESA_ROL_ID
  INNER JOIN DB_GENERAL.ADMI_ROL ROL_CONTACTO
  ON ROL_CONTACTO.ID_ROL = IER.ROL_ID
  INNER JOIN DB_GENERAL.ADMI_TIPO_ROL TIPO_ROL_CONTACTO
  ON TIPO_ROL_CONTACTO.ID_TIPO_ROL = ROL_CONTACTO.TIPO_ROL_ID
  INNER JOIN DB_COMERCIAL.ADMI_FORMA_CONTACTO FORMA_CONTACTO
  ON FORMA_CONTACTO.ID_FORMA_CONTACTO            = PERSONA_F_CONTACTO.FORMA_CONTACTO_ID
  WHERE PUNTO_CONTACTO.ESTADO                    = 'Activo'
  AND PERSONA_F_CONTACTO.ESTADO                  = 'Activo'
  AND ROL_CONTACTO.DESCRIPCION_ROL               = 'Contacto Tecnico'
  AND TIPO_ROL_CONTACTO.DESCRIPCION_TIPO_ROL     = 'Contacto'
  AND FORMA_CONTACTO.DESCRIPCION_FORMA_CONTACTO IN ('Correo Electronico', 'Telefono Fijo', 'Telefono Movil', 
                                                    'Telefono Movil Claro', 'Telefono Movil Movistar', 'Telefono Movil CNT')
  AND FORMA_CONTACTO.ESTADO                      = 'Activo'
  ) INFO_CONTACTO ON INFO_CONTACTO.PUNTO_ID      = PUNTO.ID_PUNTO
WHERE PRODUCTO.DESCRIPCION_PRODUCTO IN (
SELECT DET.VALOR1 
FROM DB_GENERAL.ADMI_PARAMETRO_CAB CAB
INNER JOIN DB_GENERAL.ADMI_PARAMETRO_DET DET
ON DET.PARAMETRO_ID = CAB.ID_PARAMETRO
WHERE CAB.NOMBRE_PARAMETRO = 'DESCRIPCION_PRODUCTO_V_SCANNING_FIREWALL'
AND CAB.ESTADO = 'Activo'
AND DET.ESTADO = 'Activo');
