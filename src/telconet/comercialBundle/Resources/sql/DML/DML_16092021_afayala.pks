/**
 * Documentación para crear características y productos con características INTERNET SAFE
 *
 * @author Antonio Ayala <afayala@telconet.ec>
 * @version 1.0 16-09-2021
 */

SET SERVEROUTPUT ON
--Creación de producto internet safe
DECLARE
  Ln_IdProducto   NUMBER;
  Ln_IdComision   NUMBER;
BEGIN
  Ln_IdProducto := DB_COMERCIAL.SEQ_ADMI_PRODUCTO.NEXTVAL;
  Ln_IdComision := DB_COMERCIAL.SEQ_ADMI_COMISION_CAB.NEXTVAL;
  
--INSERT ADMI_PRODUCTO
INSERT INTO DB_COMERCIAL.ADMI_PRODUCTO 
				        SELECT Ln_IdProducto,
								AP.EMPRESA_COD,
								AP.CODIGO_PRODUCTO,
								'INTERNET SAFE',
								AP.FUNCION_COSTO,
								AP.INSTALACION,
								AP.ESTADO,
								SYSDATE,
								'afayala',
								AP.IP_CREACION,
								AP.CTA_CONTABLE_PROD,
								AP.CTA_CONTABLE_PROD_NC,
								AP.ES_PREFERENCIA,
								AP.ES_ENLACE,
								AP.REQUIERE_PLANIFICACION,
								AP.REQUIERE_INFO_TECNICA,
								AP.NOMBRE_TECNICO,
								AP.CTA_CONTABLE_DESC,
								AP.TIPO,
								AP.ES_CONCENTRADOR,
								AP.FUNCION_PRECIO,
								AP.SOPORTE_MASIVO,
								AP.ESTADO_INICIAL,
								AP.GRUPO,
								AP.COMISION_VENTA,
								AP.COMISION_MANTENIMIENTO,
								AP.USR_GERENTE,
								AP.CLASIFICACION,
								AP.REQUIERE_COMISIONAR,
								AP.SUBGRUPO,
								AP.LINEA_NEGOCIO,
                                                                AP.TERMINO_CONDICION,
                                                                AP.FRECUENCIA
				FROM DB_COMERCIAL.ADMI_PRODUCTO AP 
				WHERE AP.DESCRIPCION_PRODUCTO='TELEWORKER' 
								AND AP.ESTADO='Activo' 
								AND AP.NOMBRE_TECNICO='INTERNET SMALL BUSINESS' AND AP.EMPRESA_COD=10;  
                
--INSERT ADMI_PRODUCTO_CARACTERISTICA
INSERT INTO DB_COMERCIAL.ADMI_PRODUCTO_CARACTERISTICA 
				SELECT DB_COMERCIAL.SEQ_ADMI_PRODUCTO_CARAC.NEXTVAL,
								Ln_IdProducto,
								AP.CARACTERISTICA_ID,
								SYSDATE,
								AP.FE_ULT_MOD,
								'afayala',
								AP.USR_ULT_MOD,
								AP.ESTADO,
								AP.VISIBLE_COMERCIAL
				FROM DB_COMERCIAL.ADMI_PRODUCTO_CARACTERISTICA AP 
				WHERE AP.PRODUCTO_ID = (SELECT ID_PRODUCTO FROM DB_COMERCIAL.ADMI_PRODUCTO WHERE DESCRIPCION_PRODUCTO = 'TELEWORKER' ) 
								AND AP.ESTADO='Activo';
                
--INSERT INFO_PRODUCTO_IMPUESTO
INSERT INTO DB_COMERCIAL.INFO_PRODUCTO_IMPUESTO 
				SELECT DB_COMERCIAL.SEQ_INFO_PRODUCTO_IMPUESTO.NEXTVAL,
								Ln_IdProducto,
								AP.IMPUESTO_ID,
								AP.PORCENTAJE_IMPUESTO,
								SYSDATE,
								'afayala',
								AP.FE_ULT_MOD,
								AP.USR_ULT_MOD,
								AP.ESTADO
				FROM DB_COMERCIAL.INFO_PRODUCTO_IMPUESTO AP 
				WHERE AP.PRODUCTO_ID = (SELECT ID_PRODUCTO FROM DB_COMERCIAL.ADMI_PRODUCTO WHERE DESCRIPCION_PRODUCTO = 'TELEWORKER' ) 
								AND AP.ESTADO='Activo';

--INSERT ADMI_COMISION_CAB
INSERT INTO DB_COMERCIAL.ADMI_COMISION_CAB VALUES
               (Ln_IdComision,
								Ln_IdProducto,
								NULL,
								SYSDATE,
								'afayala',
								'127.0.0.1',
								'Activo' );

--INSERT ADMI_COMISION_DET
INSERT INTO DB_COMERCIAL.ADMI_COMISION_DET VALUES
				        (DB_COMERCIAL.SEQ_ADMI_COMISION_DET.NEXTVAL,
								Ln_IdComision,
								3190,
								3,
								SYSDATE,
								'afayala',
								'172.0.0.1',
								'Activo');

--INSERT ADMI_CARACTERISTICA
INSERT INTO DB_COMERCIAL.ADMI_CARACTERISTICA VALUES
                                  ( DB_COMERCIAL.SEQ_ADMI_CARACTERISTICA.NEXTVAL,
                                   'VELOCIDAD_INTERNET_SAFE',
                                   'S',
                                   'Activo',
                                   SYSDATE,
                                   'afayala',
                                   NULL,
                                   NULL,
                                   'COMERCIAL',
                                   NULL);  

--UPDATE ADMI_PRODUCTO_CARACTERISTICA
UPDATE DB_COMERCIAL.ADMI_PRODUCTO_CARACTERISTICA SET CARACTERISTICA_ID = (SELECT ID_CARACTERISTICA FROM DB_COMERCIAL.ADMI_CARACTERISTICA 
WHERE DESCRIPCION_CARACTERISTICA = 'VELOCIDAD_INTERNET_SAFE')
WHERE CARACTERISTICA_ID = (SELECT ID_CARACTERISTICA FROM DB_COMERCIAL.ADMI_CARACTERISTICA WHERE DESCRIPCION_CARACTERISTICA = 'VELOCIDAD')
AND PRODUCTO_ID = (SELECT ID_PRODUCTO FROM DB_COMERCIAL.ADMI_PRODUCTO WHERE DESCRIPCION_PRODUCTO = 'INTERNET SAFE');

--UPDATE ADMI_PRODUCTO
UPDATE DB_COMERCIAL.ADMI_PRODUCTO SET FUNCION_PRECIO = 'if ([VELOCIDAD_INTERNET_SAFE]==15) { PRECIO = 17.50; } else if ([VELOCIDAD_INTERNET_SAFE]==20) { PRECIO = 20.00; } else if ([VELOCIDAD_INTERNET_SAFE]==25) { PRECIO = 23.00; } else if ([VELOCIDAD_INTERNET_SAFE]==30) { PRECIO = 24.90; } else if ([VELOCIDAD_INTERNET_SAFE]==40) { PRECIO = 27.50; } else if ([VELOCIDAD_INTERNET_SAFE]==50) { PRECIO = 29.99; }' 
WHERE DESCRIPCION_PRODUCTO = 'INTERNET SAFE'
AND EMPRESA_COD = '10';

				
SYS.DBMS_OUTPUT.PUT_LINE('Se clonó producto internet safe igual que al producto teleworker');
  COMMIT;
EXCEPTION
WHEN OTHERS THEN
  SYS.DBMS_OUTPUT.PUT_LINE('Error: '|| SQLCODE || ' - ERROR_STACK: ' || DBMS_UTILITY.FORMAT_ERROR_STACK || ' - ERROR_BACKTRACE: ' 
                           || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
  ROLLBACK;
END;
/
